package poly.controller;

import poly.service.impl.KakaoService;

import org.mortbay.log.Log;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.ModelMap;
/*import org.springframework.web.bind.annotation.GetMapping;*/
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;

import java.util.HashMap;

import javax.servlet.http.HttpSession;

@Controller
public class KakaoController {

    @Autowired
    private KakaoService kakao;

    @RequestMapping(value="/")
    public String index() {
    	return "/DExellent/index";
    }
    
    @RequestMapping("kakaologin")
    public String kakaologin(@RequestParam("code") String code, HttpSession session) {
        System.out.println(this.getClass().getName() + ".kakaologin start!");
        System.out.println("code: " + code);

        String access_token = kakao.getAccessToken(code);
        System.out.println("controller access_token: " + access_token);

        HashMap<String, Object> userInfo = kakao.getUserInfo(access_token);
        
        System.out.println("kakaologin controller : " + userInfo);
        
        if (userInfo.get("email") != null) {
        session.setAttribute("user_name", userInfo.get("nickname"));
        session.setAttribute("user_mail", userInfo.get("email"));
        session.setAttribute("user_range", userInfo.get("age_range"));
		/* session.setAttribute("access_token", access_token); */
        }
        System.out.println(this.getClass().getName() + ".kakaologin end!");

        return "/DExellent/index";
    }
    
    @RequestMapping(value="kakaologout")
    public void kakaologout(ModelMap model, HttpSession session) throws Exception {
    	
    	session.invalidate();
       	model.addAttribute("msg", "로그아웃 되었습니다.");
    	model.addAttribute("url", "/DExcellent/index");

    }
    
    /*
    @RequestMapping(value="/kakaologout")
    public String kakaologout(HttpSession session) {
    	kakao.kakaoLogout((String)session.getAttribute("access_token"));
    	
    	session.removeAttribute("access_token");
    	session.removeAttribute("userId");
    	
    	return "/DExellent/index";
    } */
}